<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è</title>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
        }
        
        .experiment-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            line-height: 1.8;
        }
        
        h2 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .instruction-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin: 20px 0;
        }
        
        .jspsych-survey-likert {
            margin: 20px 0;
        }
        
        .jspsych-survey-likert-statement {
            font-size: 17px;
            margin-bottom: 15px;
            font-weight: 500;
            color: #333;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .jspsych-survey-likert-opts {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            gap: 5px;
        }
        
        .jspsych-survey-likert-opt {
            flex: 1;
            text-align: center;
        }
        
        .jspsych-survey-likert-opt-label {
            display: block;
            cursor: pointer;
            padding: 10px 5px;
            border-radius: 5px;
            transition: all 0.3s;
            font-size: 14px;
            line-height: 1.3;
        }
        
        .jspsych-survey-likert-opt input[type="radio"] {
            margin-bottom: 5px;
        }
        
        .jspsych-survey-likert-opt:hover .jspsych-survey-likert-opt-label {
            background: #e9ecef;
        }
        
        .jspsych-survey-likert-opt input[type="radio"]:checked ~ .jspsych-survey-likert-opt-label {
            background: #667eea;
            color: white;
            font-weight: bold;
        }
        
        .continue-instruction {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            margin-top: 30px;
            font-size: 16px;
        }
        
        #download-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            margin: 30px auto;
        }
        
        #download-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .audio-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
</body>
<script>

// ============================================
// –ù–ê–°–¢–†–û–ô–ö–ò
// ============================================

const PARTICIPANT_ID = 'PILOT_' + Date.now();
const CONDITION = 'meditation_pilot';

// ============================================
// –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø JSPSYCH
// ============================================

const jsPsych = initJsPsych({
    on_finish: function() {
        displayResults();
    }
});

// ============================================
// DSS-4 –û–ü–†–û–°–ù–ò–ö
// ============================================

const DSS4_ITEMS = [
    '–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å –æ–∫—Ä—É–∂–∞—é—â–∞—è —Å—Ä–µ–¥–∞ –∫–∞–∂–µ—Ç—Å—è –Ω–µ–æ–±—ã—á–Ω–æ–π –∏–ª–∏ –Ω–µ–º–Ω–æ–≥–æ –Ω–µ—Ä–µ–∞–ª—å–Ω–æ–π.',
    '–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å —è –æ—â—É—â–∞—é –æ—Ç–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å –æ—Ç —Å–µ–±—è, —Å–ª–æ–≤–Ω–æ –Ω–∞–±–ª—é–¥–∞—é –∑–∞ —Å–≤–æ–∏–º —Ç–µ–ª–æ–º –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã.',
    '–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å –º–æ–∏ —ç–º–æ—Ü–∏–∏ –æ—â—É—â–∞—é—Ç—Å—è –ø—Ä–∏–≥–ª—É—à—ë–Ω–Ω—ã–º–∏ –∏–ª–∏ –¥–∞–ª—ë–∫–∏–º–∏, –∫–∞–∫ –±—É–¥—Ç–æ –º–µ–∂–¥—É –Ω–∏–º–∏ –∏ –º–Ω–æ–π –µ—Å—Ç—å –±–∞—Ä—å–µ—Ä.',
    '–ü—Ä—è–º–æ —Å–µ–π—á–∞—Å –º–æ—ë –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–µ–≥–æ –≤–æ–∫—Ä—É–≥ –∫–∞–∂–µ—Ç—Å—è –æ—Å–ª–∞–±–ª–µ–Ω–Ω—ã–º –∏–ª–∏ —Ä–∞–∑–º—ã—Ç—ã–º.'
];

const LIKERT_SCALE = [
    '0 ‚Äî –°–æ–≤—Å–µ–º –Ω–µ—Ç',
    '1 ‚Äî –û—á–µ–Ω—å —Å–ª–∞–±–æ–µ',
    '2 ‚Äî –£–º–µ—Ä–µ–Ω–Ω–æ–µ',
    '3 ‚Äî –í—ã—Ä–∞–∂–µ–Ω–Ω–æ–µ',
    '4 ‚Äî –°–∏–ª—å–Ω–æ–µ'
];

function createDSS4(phase) {
    return {
        type: jsPsychSurveyLikert,
        preamble: `
            <div class="experiment-container">
                <h2>–û–ø—Ä–æ—Å–Ω–∏–∫</h2>
                <div class="instruction-box">
                    <p>–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è.</p>
                    <p>–û—Ü–µ–Ω–∏—Ç–µ, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ –≤—ã –æ—â—É—â–∞–µ—Ç–µ –∫–∞–∂–¥–æ–µ –∏–∑ –Ω–∏—Ö <strong>–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</strong>.</p>
                    <p style="color: #667eea; font-weight: bold;">
                        –û—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Ç–µ—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–≤–æ—ë —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç.
                    </p>
                </div>
            </div>
        `,
        questions: DSS4_ITEMS.map((item, index) => ({
            prompt: `<strong>${index + 1}.</strong> ${item}`,
            name: `dss4_${phase}_q${index + 1}`,
            labels: LIKERT_SCALE,
            required: true
        })),
        randomize_question_order: false,
        button_label: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
        on_finish: function(data) {
            data.phase = phase;
            data.participant_id = PARTICIPANT_ID;
            data.condition = CONDITION;
            data.questionnaire = 'DSS4';
            data.timestamp = new Date().toISOString();
            
            // –ü–æ–¥—Å—á—ë—Ç —Å—É–º–º–∞—Ä–Ω–æ–≥–æ –±–∞–ª–ª–∞
            let total_score = 0;
            for (let i = 1; i <= 4; i++) {
                total_score += parseInt(data.response[`dss4_${phase}_q${i}`]);
            }
            data.dss4_total_score = total_score;
        }
    };
}

// ============================================
// TIMELINE
// ============================================

let timeline = [];

// 1. –ö—Ä–∞—Ç–∫–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
        <div class="experiment-container">
            <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
            
            <div class="instruction-box">
                <p style="font-size: 18px;">
                    –°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ –≤ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–∏.
                </p>
                <p style="font-size: 18px;">
                    –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –∑–∞–π–º—ë—Ç –æ–∫–æ–ª–æ <strong>20 –º–∏–Ω—É—Ç</strong>.
                </p>
                <p style="font-size: 18px; margin-top: 20px;">
                    –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —á–µ—Å—Ç–Ω–æ, 
                    –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É—è—Å—å –Ω–∞ —Å–≤–æ–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ—â—É—â–µ–Ω–∏—è.
                </p>
            </div>
            
            <p class="continue-instruction">–ù–∞–∂–º–∏—Ç–µ –ü–†–û–ë–ï–õ –¥–ª—è –Ω–∞—á–∞–ª–∞</p>
        </div>
    `,
    choices: [' ']
});

// 2. DSS-4 –î–û –∞—É–¥–∏–æ
timeline.push(createDSS4('pre'));

// 3. –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∞—É–¥–∏–æ
timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
        <div class="experiment-container">
            <h2>–ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ</h2>
            
            <div class="instruction-box">
                <p style="font-size: 18px;">
                    –°–µ–π—á–∞—Å –≤—ã –ø—Ä–æ—Å–ª—É—à–∞–µ—Ç–µ –∞—É–¥–∏–æ–∑–∞–ø–∏—Å—å.
                </p>
                <p style="font-size: 18px; margin-top: 15px;">
                    –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ –∞—É–¥–∏–æ.
                </p>
            </div>
            
            <p class="continue-instruction">–ù–∞–∂–º–∏—Ç–µ –ü–†–û–ë–ï–õ –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è</p>
        </div>
    `,
    choices: [' ']
});

// 4. –ê—É–¥–∏–æ
timeline.push({
    type: jsPsychAudioKeyboardResponse,
    stimulus: 'meditation_audio.mp3',
    prompt: `
        <div class="experiment-container">
            <h2>–ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ</h2>
            <div class="audio-container">
                <p style="font-size: 18px; color: #667eea;">
                    –ò–¥—ë—Ç –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–∏...
                </p>
            </div>
            <p style="text-align: center; margin-top: 30px; color: #6c757d; font-size: 16px;">
                <em>–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ –ü–†–û–ë–ï–õ</em>
            </p>
        </div>
    `,
    choices: [' '],
    trial_ends_after_audio: false,
    on_finish: function(data) {
        data.participant_id = PARTICIPANT_ID;
        data.condition = CONDITION;
        data.trial_type = 'audio_meditation';
        data.audio_duration_ms = data.rt;
        data.timestamp = new Date().toISOString();
    }
});

// 5. –ü–µ—Ä–µ—Ö–æ–¥ –∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –æ–ø—Ä–æ—Å–Ω–∏–∫—É
timeline.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
        <div class="experiment-container">
            <h2>–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ</h2>
            
            <div class="instruction-box">
                <p style="font-size: 18px;">
                    –¢–µ–ø–µ—Ä—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Ç–µ –∂–µ –≤–æ–ø—Ä–æ—Å—ã –µ—â—ë —Ä–∞–∑.
                </p>
                <p style="font-size: 18px; color: #667eea; margin-top: 15px;">
                    –û—Ü–µ–Ω–∏—Ç–µ —Å–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ <strong>–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</strong>.
                </p>
            </div>
            
            <p class="continue-instruction">–ù–∞–∂–º–∏—Ç–µ –ü–†–û–ë–ï–õ</p>
        </div>
    `,
    choices: [' ']
});

// 6. DSS-4 –ü–û–°–õ–ï –∞—É–¥–∏–æ
timeline.push(createDSS4('post'));

// ============================================
// –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê –ê–£–î–ò–û
// ============================================

timeline.unshift({
    type: jsPsychPreload,
    audio: ['meditation_audio.mp3'],
    message: `
        <div class="experiment-container">
            <h2>–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
            <p style="text-align: center; font-size: 18px; color: #6c757d;">
                –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ
            </p>
            <div style="text-align: center; margin-top: 30px;">
                <div style="display: inline-block; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        </div>
    `,
    show_progress_bar: true
});

// ============================================
// –ó–ê–ü–£–°–ö
// ============================================

jsPsych.run(timeline);

// ============================================
// –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
// ============================================

function displayResults() {
    const data = jsPsych.data.get();
    const dss4_data = data.filter({questionnaire: 'DSS4'});
    
    const pre_data = dss4_data.filter({phase: 'pre'}).values()[0];
    const post_data = dss4_data.filter({phase: 'post'}).values()[0];
    
    const pre_score = pre_data ? pre_data.dss4_total_score : 0;
    const post_score = post_data ? post_data.dss4_total_score : 0;
    const difference = post_score - pre_score;
    
    document.body.innerHTML = `
        <div class="experiment-container">
            <h2>–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –∑–∞–≤–µ—Ä—à—ë–Ω</h2>
            
            <div class="instruction-box">
                <p style="font-size: 18px;">
                    –°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ!
                </p>
                <p style="font-size: 18px; margin-top: 15px;">
                    –í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:<br>
                    –î–æ: ${pre_score} –±–∞–ª–ª–æ–≤<br>
                    –ü–æ—Å–ª–µ: ${post_score} –±–∞–ª–ª–æ–≤<br>
                    –ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${difference > 0 ? '+' : ''}${difference}
                </p>
            </div>
            
            <button id="download-btn" onclick="downloadData()">
                üì• –°–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
            </button>
            
            <p style="text-align: center; color: #dc3545; font-size: 16px; margin-top: 20px;">
                –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö!
            </p>
            
            <p style="text-align: center; color: #6c757d; font-size: 14px; margin-top: 20px;">
                ID: ${PARTICIPANT_ID}
            </p>
        </div>
    `;
}

function downloadData() {
    const csv = jsPsych.data.get().csv();
    const filename = `pilot_data_${PARTICIPANT_ID}.csv`;
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    alert('–î–∞–Ω–Ω—ã–µ —Å–∫–∞—á–∞–Ω—ã! –ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
}

</script>
</html>
